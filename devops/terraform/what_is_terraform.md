# Terraform

테라폼은 **Infrastructure as Code**를 구현하는 도구이다 (이때 as 는 동격의 의미). 즉, 테라폼은 인프라스트럭처가 곧 코드이고, 코드가 곧 인프라스턱처이도록 만들어주는 도구라고 볼 수 있다.

클라우드를 관리하고 도와주는 도구들은 여러가지 있지만 현 시점에서는 Infrastructure as Code가 이중에서 끝판왕에 해당하는 것으로 볼 수 있다.

인프라스터럭처를 `HCL`이라는 언어로 `tf` 파일에 선언적으로 작성한다.

    resource "aws_instance" "web" {
    	ami = "${data.aws_ami.ubuntu.id}"
    	instance_type = "t2.micro"
    	tags = {
    		Name = "HelloWorld"
    	}
    }

AWS EC2의 인스턴스를 위와 같이 선언한다. 이 코드를 적용하면 인스턴스가 생성된다. 그래서 인프라가 곧 코드, 코드가 곧 인프라라고 말하는 이유이다.

테라폼은 단순히 리소스를 생성하는 역할뿐만 아니라 코드에 선언적으로 정의된 리소스들의 상태를 유지시켜준다. 위 코드를 여러번 실행한다고 서버가 여러대 생성되는 것이 아니다. 선언된 서버가 존재하지 않으면 생성되는 것이다.

aws web console에서 위에서 생성한 인스턴스를 종료시켰다고 가정하자. 테라폼을 적용하면 이제 서버가 없다고 판단하고, 다시 서버를 생성한다. 즉, **테라폼은 항상 코드의 상태를 기준으로 클라우드의 실제 상태를 유지하고자 한다.** 이 상태를 `tfstate` 라고 불리는 특별한 파일로 관리한다.

여러대의 서버를 만들고 싶으면 리소스를 여러번 선언하거나, `count` 속성을 사용하면 된다. 

인스턴스들을 관리해주는 오토 스케일링 그룹과 같은 상위 개념의 리소스를 사용할 수도 있다. 또한 테라폼은 리소스들 간의 의존 관계를 이해한다. 인스턴스를 생성할 때 보안 그룹이 필요한 경우가 있다

    resource "aws_instance" "web" {
    	...
    	vpc_security_group_ids = [aws_security_group.web.id]
    }
    
    resource "aws_security_group" "web" {
    	...
    }

인스턴스의 보안그룹 속성을 정의할 때 테라폼에 정의된 보안 그룹을 참조하도록 작성하였다. 테라폼이 인스턴스를 생성할 때 `aws_security_group.web.id` 에서 해당 보안 그룹의 id 를 알 수 없기 때문에 이런 경우 테라폼은 인스턴스가 보안 그룹에 의존성이 있다고 판단하기때문에 위 코드를 적용하면 테라폼은 보안 그룹을 먼저 생성하고 인스턴스를 생성한다. 따라서 테라폼 코드에서는 리소스 정의 순서가 중요하지 않다.

테라폼은 **플랜**이라는 강력한 기능도 제공한다. 이 기능은 실제로 `tf` 파일을 클라우드에 적용하기 전에 예상되는 변경사항들을 모아서 보여준다. 코드와 클라우드 사이의 `diff` 를 출력하는 기능이다. 이를 통해 점진적으로 시스템을 설계해나갈 수 있다. 

테라폼 코드로 작성해나가면 복잡한 시스템의 설계도가 완성이 된다! WoW

테라폼은 여러 클라우드 서비스 들을 지원해주는 것 뿐만아니라 데이터베이스, 쿠버네티스 클러스터, 모니터링 서버 등을 관리하는 프로바이더도 제공하고 있다.

## Reference

[[4분코딩] 테라폼(Terraform): Infrastructure as Code](https://www.youtube.com/watch?v=SGH0uDni-WY&t=190s)
